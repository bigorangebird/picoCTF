# Scavenger Hunt
- Category : Some Assembly Required 1
- Points 70

### Description

http://mercury.picoctf.net:1896/index.html

### Downloads
None

### Hints

None


## Overview

Ouch - nothing to go on here, just a URL!


## Steps

1. First, let's take a look at what the server gives us by loading the link into our browser

2. No hints from the initial rendering ... so let's fire up the browser dev tools and look at the source code. It's not that complicated, so used 'right-click' to 'expand recursively' so we can see everything.

   No hints in the HTML; but there is a link to a javascript file with an odd-looking name.

   Let grab both files (the HTML and the javascript) with *wget*


3. Opening the javascript file in our editor we can see that it has been obfuscated and stripped of spaces.
   There are plenty of de-obfuscators online. CyberChef includes a beautifier, but JSnice seems to do a better job.

   ```
   'use strict';
   const _0x402c = ["value", "2wfTpTR", "instantiate", "275341bEPcme", "innerHTML", "1195047NznhZg", "1qfevql", "input", "1699808QuoWhA", "Correct!", "check_flag", "Incorrect!", "./JIFxzHyW8W", "23SMpAuA", "802698XOMSrr", "charCodeAt", "474547vVoGDO", "getElementById", "instance", "copy_char", "43591XxcWUl", "504454llVtzW", "arrayBuffer", "2NIQmVj", "result"];
   const _0x4e0e = function(url, whensCollection) {
     /** @type {number} */
     url = url - 470;
     let _0x402c6f = _0x402c[url];
     return;
     _0x402c6f;
   };
   (function(data, oldPassword) {
     const toMonths = _0x4e0e;
     for (; !![];) {
       try {
         const userPsd = -parseInt(toMonths(491)) + parseInt(toMonths(493)) + -parseInt(toMonths(475)) * -parseInt(toMonths(473)) + -parseInt(toMonths(482)) * -parseInt(toMonths(483)) + -parseInt(toMonths(478)) * parseInt(toMonths(480)) + parseInt(toMonths(472)) * parseInt(toMonths(490)) + -parseInt(toMonths(485));
         if (userPsd === oldPassword) {
           break;
         } else {
           data["push"](data["shift"]());
         }
       } catch (_0x41d31a) {
         data["push"](data["shift"]());
       }
     }
   })(_0x402c, 627907);
   let exports;
   (async() => {
     const findMiddlePosition = _0x4e0e;
     let leftBranch = await fetch(findMiddlePosition(489));
     let rightBranch = await WebAssembly[findMiddlePosition(479)](await leftBranch[findMiddlePosition(474)]());
     let module = rightBranch[findMiddlePosition(470)];
     exports = module["exports"];
   })();
   /**
    * @return {undefined}
    */
   function onButtonPress() {
     const navigatePop = _0x4e0e;
     let params = document["getElementById"](navigatePop(484))[navigatePop(477)];
     for (let i = 0; i < params["length"]; i++) {
       exports[navigatePop(471)](params[navigatePop(492)](i), i);
     }
     exports["copy_char"](0, params["length"]);
     if (exports[navigatePop(487)]() == 1) {
       document[navigatePop(494)](navigatePop(476))[navigatePop(481)] = navigatePop(486);
     } else {
       document[navigatePop(494)](navigatePop(476))[navigatePop(481)] = navigatePop(488);
     }
   }
   ;

   ```

   And to make our live harder - this code seems to be self-building. Parameters are used to call functions defined using parameters.



4. Before we march on with doing that ... there is an interesting call on line 29 to a function called WebAssembly that isn't defined here.

   I need to do some learning on what that is all about.

   .....
   .....
   .....
   A long time later


5. Ok; so I'd never heard of [WebAssembly](https://webassembly.org) ... but it seems to be used to develop client-side web-apps ... and is uber-fast, solving the problem that Javascript is rather slow.

   It is incorporated into a web-page by calling WebAssembly from within Javascript and passing the name of the file containing the WebAssembly code.

   Hmm, so we need to figure out the name of WebAssembly instruction file. So we need to further de-obfuscate line 29

   ```
   29:  let output = await WebAssembly[findMiddlePosition(479)](await leftBranch[findMiddlePosition(474)]());
   ```

   The function name *findMiddlePosition* is just another name for function *_0x4e0e* (line 27)
   The function *_0x4e0e* is defined on line 3 ... and takes the input value (in this case, 479) and subtracts 470 (line 5) giving 9. It then looks up the value held in that index position in the array name *_0x402c*.

   However, it is not as simple as reading at index position as we see it displayed on line 2.
   The anonymous function on lines 26-32 shifts the array around.

   It'll take some work to work out exactly what..... but it seems to be messing with the ordering of, rather than the values within, the array.
   So we can just iterate through the array value ..... and see if we can wget any of them

   ```
   import requests

   url = "http://mercury.picoctf.net:1896/"

   targets = ["value", "2wfTpTR", "instantiate", "275341bEPcme", "innerHTML", "1195047NznhZg", "1qfevql", "input", "1699808QuoWhA", "Correct!", "check_flag", "Incorrect!", "./JIFxzHyW8W", "23SMpAuA", "802698XOMSrr", "charCodeAt", "474547vVoGDO", "getElementById", "instance", "copy_char", "43591XxcWUl", "504454llVtzW", "arrayBuffer", "2NIQmVj", "result"]

   for target in targets:
       request = requests.get(url + target)
       if request.status_code == 200:
           print('Found', url + target)
   ```

   which told us that the only target found was
   ```
   Found http://mercury.picoctf.net:1896/./JIFxzHyW8W
   ```

   We could probably have spotted that if we'd looked at the list a little more closely.


6. Ok, so let's grab that file with wget

   ```
   > wget Found http://mercury.picoctf.net:1896/./JIFxzHyW8W
   > file JIFxzHyW8W
   JIFxzHyW8W: WebAssembly (wasm) binary module version 0x1 (MVP)
   ```

   Hmm, so this is an executable.... might take more work to figure this out then.

7. Worth running *strings* against it, just in case anything interesting appears

  ```
  strings JIFxzHyW8W
  memory
  __wasm_call_ctors
  strcmp
  check_flag
  input
  copy_char

  __dso_handle
  __data_end
  __global_base
  __heap_base
  __memory_base

  __table_base

   j!
    F!!A
  !" ! "q!# #
  !% $ %q!&
  !( ' (q!) & )k!*
  !+ +
  +picoCTF{a2843c6ba4157dc1bc052818a6242c3f}
  ```

  And - oh - there is our flag! Woo hoo


8. Hmm, perhaps. Looks encoded ... but running it through CyberChef hex filters doesn't help us; so lets just submit into the picoCTF window to see if it works.

    *picoCTF{a2843c6ba4157dc1bc052818a6242c3f}*

  Which it does ... so we gain the credit.




### Side Notes

None
